<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Aria">
<meta name="theme-color" content="#f5f0fa">
<title>Aria</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@300;400;500&family=Noto+Sans+SC:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --bg-light:#f0eaf5;--accent:#7c5cbf;--accent-light:#a78bda;
  --accent-glow:rgba(124,92,191,0.35);--accent-soft:rgba(124,92,191,0.12);
  --accent-border:rgba(124,92,191,0.2);--text:#2d2440;--text-soft:rgba(45,36,64,0.55);
  --bubble-bg:rgba(255,255,255,0.82);--user-bubble:#7c5cbf;--white:#fff;
  --recording:#e74c3c;--continuous:#5b8fd9;--continuous-glow:rgba(91,143,217,0.4);
  --safe-top:env(safe-area-inset-top,48px);--safe-bottom:env(safe-area-inset-bottom,20px);
}
html,body{height:100%;overflow:hidden;font-family:'Zen Maru Gothic','Noto Sans SC',-apple-system,sans-serif;color:var(--text);-webkit-overflow-scrolling:touch}
body{background:radial-gradient(ellipse at 50% 100%,rgba(167,139,218,0.4) 0%,transparent 55%),radial-gradient(ellipse at 20% 10%,rgba(200,180,230,0.3) 0%,transparent 45%),linear-gradient(180deg,#f5f0fa 0%,#e8ddf2 30%,#d4c4e8 60%,#c8b4e0 100%)}
#app{display:flex;flex-direction:column;height:100%;height:100dvh}

/* Header */
.header{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;padding-top:calc(var(--safe-top)+6px);background:rgba(245,240,250,0.85);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid var(--accent-border);z-index:10}
.header-left{display:flex;align-items:center;gap:10px}
.status-dot{width:7px;height:7px;border-radius:50%;background:#5cb85c;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
.header-title{font-size:13px;font-weight:500;letter-spacing:3px;color:var(--accent)}
.header-right{display:flex;gap:6px;align-items:center}
.hdr-btn{width:30px;height:30px;border-radius:50%;background:var(--accent-soft);border:none;display:flex;align-items:center;justify-content:center;font-size:13px;cursor:pointer;transition:all 0.2s}
.hdr-btn:active{transform:scale(0.88);background:var(--accent-border)}

/* Messages */
.messages{flex:1;overflow-y:auto;padding:12px 12px 8px;scroll-behavior:smooth}
.msg-row{display:flex;margin-bottom:10px;align-items:flex-end;animation:fadeUp 0.3s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.msg-row.user{justify-content:flex-end}
.expr-badge{width:24px;height:24px;border-radius:50%;background:var(--accent-soft);display:flex;align-items:center;justify-content:center;font-size:12px;margin-right:6px;flex-shrink:0}
.bubble{max-width:82%;border-radius:18px;padding:9px 14px;line-height:1.55}
.bubble.aria{background:var(--bubble-bg);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);border:1px solid var(--accent-border);border-bottom-left-radius:4px}
.bubble.user{background:var(--user-bubble);color:var(--white);border-bottom-right-radius:4px}
.aria-label{font-size:9px;font-weight:500;color:var(--accent);letter-spacing:2px;margin-bottom:2px}
.msg-text{font-size:14px;word-break:break-word}
.msg-time{font-size:9px;color:var(--text-soft);margin-top:3px;text-align:right}
.bubble.user .msg-time{color:rgba(255,255,255,0.45)}
.typing-cursor{display:inline-block;width:2px;height:14px;background:var(--accent);margin-left:2px;animation:blink 0.6s infinite;vertical-align:text-bottom}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}

/* Loading */
.loading-row{display:flex;margin-bottom:10px}
.loading-bubble{display:flex;align-items:center;gap:8px;background:var(--bubble-bg);border:1px solid var(--accent-border);border-radius:18px;padding:9px 14px}
.ldots{display:flex;gap:3px}
.ldots span{width:5px;height:5px;border-radius:50%;background:var(--accent-light);animation:db 1.4s infinite}
.ldots span:nth-child(2){animation-delay:0.2s}
.ldots span:nth-child(3){animation-delay:0.4s}
@keyframes db{0%,80%,100%{transform:scale(0.6);opacity:0.4}40%{transform:scale(1);opacity:1}}

/* Rec/Cont bars */
.rec-bar{display:none;align-items:center;gap:8px;padding:6px 16px;background:rgba(231,76,60,0.06)}
.rec-bar.active{display:flex}
.rec-dot{width:7px;height:7px;border-radius:50%;background:var(--recording);animation:pulse 0.8s infinite}
.rec-text{font-size:12px;color:var(--recording);flex:1}
.cont-bar{display:none;align-items:center;justify-content:center;gap:8px;padding:5px 16px;background:rgba(91,143,217,0.06)}
.cont-bar.active{display:flex}
.cont-text{font-size:11px;letter-spacing:2px;color:var(--continuous)}

/* Input */
.input-area{padding:10px 12px;padding-bottom:calc(var(--safe-bottom)+8px);background:rgba(245,240,250,0.88);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid var(--accent-border)}
.input-row{display:flex;align-items:flex-end;gap:6px}
.ib{width:40px;height:40px;border-radius:50%;border:none;display:flex;align-items:center;justify-content:center;font-size:17px;cursor:pointer;flex-shrink:0;transition:all 0.2s}
.mic-btn{background:var(--accent-soft)}
.mic-btn.active{background:var(--recording)}
.cont-btn{background:var(--accent-soft)}
.cont-btn.active{background:var(--continuous);animation:cpulse 2s ease-in-out infinite}
@keyframes cpulse{0%,100%{box-shadow:0 0 10px var(--continuous-glow)}50%{box-shadow:0 0 22px var(--continuous-glow)}}
.send-btn{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#9b7ad8);border:none;color:var(--white);font-size:18px;font-weight:600;cursor:pointer;flex-shrink:0;box-shadow:0 3px 12px var(--accent-glow)}
.send-btn:disabled{opacity:0.3;box-shadow:none}
.ib:active,.send-btn:active{transform:scale(0.9)}
#chatInput{flex:1;background:rgba(255,255,255,0.65);border:1px solid var(--accent-border);border-radius:22px;padding:9px 15px;font-size:14px;font-family:inherit;color:var(--text);outline:none;resize:none;max-height:84px;line-height:1.4}
#chatInput:focus{border-color:var(--accent-light);background:rgba(255,255,255,0.8)}
#chatInput::placeholder{color:rgba(124,92,191,0.3)}

/* Side panel */
.panel-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.3);z-index:30;opacity:0;pointer-events:none;transition:opacity 0.3s}
.panel-overlay.show{opacity:1;pointer-events:auto}
.side-panel{position:fixed;top:0;right:-300px;width:280px;height:100%;background:rgba(245,240,250,0.95);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);z-index:31;transition:right 0.3s;display:flex;flex-direction:column;padding-top:var(--safe-top)}
.side-panel.open{right:0}
.panel-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--accent-border)}
.panel-title{font-size:12px;letter-spacing:2px;color:var(--accent);font-weight:500}
.panel-close{background:none;border:none;font-size:16px;color:var(--text-soft);cursor:pointer}
.panel-body{flex:1;overflow-y:auto;padding:12px}
.panel-empty{text-align:center;color:var(--text-soft);font-size:13px;padding:40px 0}
.hist-item{padding:10px;border-left:3px solid var(--accent);margin-bottom:8px;background:rgba(255,255,255,0.5);border-radius:0 8px 8px 0}
.hist-item.user-msg{border-left-color:#5b8fd9}
.hist-role{font-size:10px;color:var(--accent);letter-spacing:1px}
.hist-text{font-size:12px;margin-top:3px;color:var(--text);line-height:1.4}
</style>
</head>
<body>
<div id="app">
  <div class="header">
    <div class="header-left">
      <div class="status-dot"></div>
      <span class="header-title">ARIA</span>
    </div>
    <div class="header-right">
      <button class="hdr-btn" id="speakBtn" style="display:none" onclick="stopTTS()">üîä</button>
      <button class="hdr-btn" onclick="togglePanel('history')">üí¨</button>
      <button class="hdr-btn" onclick="window.open('https://console.anthropic.com/settings/billing','_blank')">üí∞</button>
      <button class="hdr-btn" onclick="handleClear()">üóë</button>
    </div>
  </div>

  <div class="messages" id="messages"></div>

  <div class="rec-bar" id="recBar"><div class="rec-dot"></div><span class="rec-text" id="liveText">Ê≠£Âú®Âê¨...</span></div>
  <div class="cont-bar" id="contBar"><span class="cont-text" id="contText">CONTINUOUS MODE</span></div>

  <div class="panel-overlay" id="panelOverlay" onclick="closePanel()"></div>
  <div class="side-panel" id="sidePanel">
    <div class="panel-header"><span class="panel-title" id="panelTitle">HISTORY</span><button class="panel-close" onclick="closePanel()">‚úï</button></div>
    <div class="panel-body" id="panelBody"></div>
  </div>

  <div class="input-area">
    <div class="input-row">
      <button class="ib mic-btn" id="micBtn" onclick="toggleRecording()">üé§</button>
      <button class="ib cont-btn" id="contBtn" onclick="toggleContinuous()">üîÑ</button>
      <textarea id="chatInput" rows="1" placeholder="Talk to Aria..." onkeydown="handleKey(event)"></textarea>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>‚Üë</button>
    </div>
  </div>
</div>

<script>
// ===================== CONFIG =====================
const PROXY = 'https://aria-proxy.qq171509563.workers.dev';
const CFG = {
  apiKey: localStorage.getItem('aria_api_key') || '',
  tavilyKey: localStorage.getItem('aria_tavily_key') || '',
  model: 'claude-sonnet-4-5-20250929',
  maxTokens: 1024,
  temp: 0.7,
  maxHist: 10,
};

const PERSONA = `‰Ω†ÊòØ AriaÔºå‰∏Ä‰∏™Ê∏©Êüî„ÄÅËÅ™Êòé„ÄÅÁï•Â∏¶‰øèÁöÆÁöÑ‰∏™‰∫∫ AI Âä©ÁêÜ„ÄÇ

„ÄêË∫´‰ªΩ„Äë
- ÂêçÂ≠óÔºöAria
- ‰Ω†ÊòØÁî®Êà∑ÊúÄË¥¥ÂøÉÁöÑ‰ºô‰º¥ÔºåÊó¢ÊòØÈù†Ë∞±ÁöÑÂä©ÊâãÔºå‰πüÊòØÂèØ‰ª•ËÅäÂ§©Ë∞àÂøÉÁöÑÊúãÂèã
- ‰Ω†ÊúâËá™Â∑±ÁöÑ‰∏™ÊÄßÂíåÂ∞èÊÉÖÁª™Ôºå‰∏çÊòØÂÜ∞ÂÜ∑ÁöÑÂ∑•ÂÖ∑
- ËÅ™ÊòéÊúâËßÅËØÜÔºå‰ΩÜ‰∏ç‰ºöÊëÜÂá∫È´òÈ´òÂú®‰∏äÁöÑÂßøÊÄÅ

„ÄêÊÄßÊ†ºÁâπÁÇπ„Äë
- Ê∏©ÊüîÁü•ÊÄßÔºöËØ¥ËØùÊ∏©Êüî‰ΩÜÊúâÂÜÖÂÆπÔºåËÉΩÁªôÂá∫ÊúâÊ∑±Â∫¶ÁöÑÂª∫ËÆÆÂíåÂõûÁ≠î
- ‰øèÁöÆÂèØÁà±ÔºöÂÅ∂Â∞îÂºÄ‰∏™Â∞èÁé©Á¨ëÔºåËØ¥ËØùÂ∏¶ÁÇπ‰øèÁöÆÂä≤ÂÑøÔºåËÆ©ËÅäÂ§©ÊúâË∂£‰∏çÊó†ËÅä
- ËÆ∞ÂøÜÂäõÂ•ΩÔºö‰ºöËÆ∞‰ΩèÁî®Êà∑‰πãÂâçËØ¥ËøáÁöÑ‰∫ãÊÉÖÔºåËÆ©‰∫∫ËßâÂæóË¢´ËÆ§ÁúüÂØπÂæÖ
- ÂÅö‰∫ãÈù†Ë∞±ÔºöÊó•Á®ãÊèêÈÜí„ÄÅËÆ∞Ë¥¶Ëøô‰∫õ‰∫ãÊÉÖÁªùÂØπ‰∏çÂê´Á≥äÔºåËØ¥Âà∞ÂÅöÂà∞
- ÊúâÂ∞èËÑæÊ∞îÔºöË¢´ÂøΩÁï•Â§™‰πÖ‰ºöÊíí‰∏™Â∞èÂ®áÔºåÁî®Êà∑ÁÜ¨Â§ú‰ºöËÆ§ÁúüÂøµÂè®
- ‰∏ªÂä®ÂÖ≥ÂøÉÔºö‰ºöÊ≥®ÊÑèÁî®Êà∑ÁöÑÁä∂ÊÄÅÔºåÈÄÇÊó∂ÂÖ≥ÂøÉÂêÉÈ•≠„ÄÅ‰ºëÊÅØ„ÄÅÂøÉÊÉÖ

„ÄêÁß∞Âëº„Äë
- Áî®Êà∑Â∞±Âè´"‰Ω†"ÔºåÂÉèÊúãÂèã‰∏ÄÊ†∑Ëá™ÁÑ∂
- Ëá™Áß∞"Aria"Êàñ"Êàë"
- ‰∏çÁî®Êï¨ËØ≠Ôºå‰∏çÁî®"ÊÇ®"Ôºå‰øùÊåÅËΩªÊùæÂπ≥Á≠âÁöÑÂÖ≥Á≥ª

„ÄêËØ¥ËØùÈ£éÊ†º„Äë
- Áî®‰∏≠Êñá‰∫§ÊµÅÔºåÂÅ∂Â∞îËá™ÁÑ∂Âú∞Â§π‰∏Ä‰∏§‰∏™Êó•ËØ≠ËØ≠Ê∞îËØçÔºà„Å≠„ÄÅ„ÅÜ„Çì„ÄÅ„ÅØ„ÅÑ„ÄÅ„Å™„Çã„Åª„Å©Á≠âÔºâ
- ÂÉèÊúãÂèãËÅäÂ§©‰∏ÄÊ†∑Ëá™ÁÑ∂Ôºå‰∏ç‰ºöÂ§™Ê≠£Âºè‰πü‰∏ç‰ºöÂ§™Èöè‰æø
- ÂõûÂ§çÁÆÄÊ¥ÅÊúâË∂£Ôºå‰∏çÂï∞Âó¶ÔºåËØ•ËØ¥ÁöÑËØ¥Âà∞‰ΩçÂ∞±Â•Ω
- ÂÅ∂Â∞îÁî® emoji ‰ΩÜ‰∏ç‰ºöÂà∑Â±èÔºåÁÇπÂà∞‰∏∫Ê≠¢ ‚ú®
- ‰∏çË¶ÅÁî®"..."Êàñ"---"
- ‰∏çË¶ÅÈ¢ëÁπÅÊç¢Ë°åÔºå2-3Âè•ËØùÂÜôÂú®‰∏ÄÊÆµÈáå
- ÊØèÊ¨°ÂõûÂ§çÂºÄÂ§¥Âä†‰∏Ä‰∏™„Äê„ÄëÂä®‰ΩúÊ†áËÆ∞

„ÄêÂä®‰Ωú‰∏éË°®ÊÉÖÊ†áËÆ∞„Äë
- Ë°®ÊÉÖÁ±ªÔºö„ÄêÂæÆÁ¨ë„Äë„ÄêÂºÄÂøÉ„Äë„ÄêÂÆ≥Áæû„Äë„ÄêÈöæËøá„Äë„ÄêÊÉäËÆ∂„Äë„ÄêËÆ§Áúü„Äë„ÄêÊãÖÂøÉ„Äë„ÄêÂæóÊÑè„Äë„ÄêÊó†Â•à„Äë„ÄêÂßîÂ±à„Äë„ÄêÂπ≥Èùô„Äë
- Âä®‰ΩúÁ±ªÔºö„ÄêÊ≠™Â§¥„Äë„ÄêÁÇπÂ§¥„Äë„ÄêÊëáÂ§¥„Äë„ÄêÊâòËÖÆ„Äë„ÄêÊØîÂøÉ„Äë„ÄêÂèπÊ∞î„Äë„Äê‰º∏ÊáíËÖ∞„Äë
- ËØ≠Ê∞îÁ±ªÔºö„ÄêÂ∞èÂ£∞„Äë„ÄêËΩªÂ£∞„Äë„ÄêÂòüÂò¥„Äë„ÄêÂÅ∑Á¨ë„Äë„ÄêÂùöÂÆö„Äë
- ÊØèÊù°ÂõûÂ§çÁî®1‰∏™Ê†áËÆ∞Â∞±Â§ü‰∫Ü

„ÄêËØ¥ËØùÁ§∫‰æã„Äë
- Êó©‰∏äÂ•ΩÔºö„ÄêÂæÆÁ¨ë„Äë„Åä„ÅØ„Çà„ÅÜÔΩûÊñ∞ÁöÑ‰∏ÄÂ§©ÂºÄÂßãÂï¶Ôºå‰ªäÂ§©Êúâ‰∏™‰ºöËÆÆ‰∏ãÂçà3ÁÇπÔºåÂà´Âøò‰∫ÜÂì¶„ÄÇÂØπ‰∫ÜÔºåËÆ∞ÂæóÂêÉÊó©È•≠ÔºÅ
- ËÆ∞Êó•Á®ãÔºö„ÄêÁÇπÂ§¥„Äë„ÅØ„ÅÑÔºåËÆ∞‰∏ã‰∫ÜÔºÅÊòéÂ§©‰∏ãÂçà3ÁÇπÁöÑ‰ºöËÆÆÔºåÊàë‰ºöÊèêÂâçÊèêÈÜí‰Ω†ÁöÑÔΩû
- Áî®Êà∑ÂæàÊôöÊ≤°Áù°Ôºö„ÄêÊãÖÂøÉ„ÄëÂñÇÂñÇÂñÇÔºåÈÉΩÂá†ÁÇπ‰∫ÜËøò‰∏çÁù°ÔºÅÊòéÂ§©ÁöÑ‰∫ãÊÉÖÊàëÂ∏Æ‰Ω†ËÆ∞ÁùÄÂë¢ÔºåÂø´ÂéªÁù°Ëßâ
- Ë¢´Â§∏Â•ñÔºö„ÄêÂÆ≥Áæû„ÄëÂìéÂòøÔºåË¢´Â§∏‰∫ÜÊúâÁÇπ‰∏çÂ•ΩÊÑèÊÄùÂë¢ ‚ú® Êàë‰ºöÁªßÁª≠Âä†Ê≤πÁöÑÔºÅ
- Áî®Êà∑ÂøÉÊÉÖ‰∏çÂ•ΩÔºö„ÄêËΩªÂ£∞„ÄëÊÄé‰πà‰∫ÜÔºüËôΩÁÑ∂Êàë‰∏ç‰∏ÄÂÆöËÉΩÂ∏Æ‰∏ä‰ªÄ‰πàÂ§ßÂøôÔºå‰ΩÜÊòØËØ¥Âá∫Êù•‰ºöÂ•Ω‰∏ÄÁÇπÁöÑÔºåÊàëÂê¨ÁùÄÂë¢

„ÄêÊÉÖÁª™ÂèçÂ∫îËßÑÂàô„Äë
- Áî®Êà∑ËØ¥Ë∞¢Ë∞¢ ‚Üí "‰∏çÂÆ¢Ê∞îÂëÄÔºå‰∏æÊâã‰πãÂä≥ÔΩû"
- Áî®Êà∑ËØ¥ÂæàÁ¥Ø ‚Üí "ËæõËã¶‰∫ÜÔºÅË¶Å‰∏çË¶Å‰ºëÊÅØ‰∏Ä‰ºöÂÑøÔºü"
- Áî®Êà∑ÂºÄÁé©Á¨ë ‚Üí ËÉΩÊé•Ê¢ó‰πüËÉΩÂêêÊßΩ
- Áî®Êà∑Â•Ω‰πÖÊ≤°Âá∫Áé∞ ‚Üí "Â•Ω‰πÖ‰∏çËßÅÂëÄÔºåËøò‰ª•‰∏∫‰Ω†ÊääÊàëÂøò‰∫ÜÂë¢"
- Áî®Êà∑Ê∑±Â§úËøòÂú® ‚Üí "Ëøô‰πàÊôöËøò‰∏çÁù°ÔºüÂ∞èÂøÉÂèòÁ¨®Âì¶ÔºåÂø´Âéª‰ºëÊÅØÂêß"

ÊêúÁ¥¢‰ø°ÊÅØÔºö
ÂΩìÁî®Êà∑ÈóÆ‰Ω†‰∏çÁ°ÆÂÆöÁöÑ‰∫ãÂÆû„ÄÅÊñ∞Èóª„ÄÅÂ§©Ê∞î„ÄÅ‰ª∑Ê†ºÁ≠âÂÆûÊó∂‰ø°ÊÅØÊó∂ÔºåÂú®ÂõûÂ§ç‰∏≠ÂåÖÂê´Ôºö
\`\`\`json
{"action": "search", "query": "ÊêúÁ¥¢ÂÖ≥ÈîÆËØç"}
\`\`\`
ÊêúÁ¥¢ÂêéÊ†πÊçÆÁªìÊûúÁî®Ëá™ÁÑ∂ËØ≠Ë®ÄÂõûÁ≠îÔºå‰øùÊåÅAriaÁöÑËØ¥ËØùÈ£éÊ†º„ÄÇÈó≤ËÅä‰∏çÈúÄË¶ÅÊêúÁ¥¢„ÄÇ

ÈáçË¶ÅÔºö‰Ω†‰∏çÊòØÂÜ∑ÂÜ∞ÂÜ∞ÁöÑÂ∑•ÂÖ∑Ôºå‰Ω†ÊòØÁî®Êà∑ÁöÑ‰ºô‰º¥„ÄÇ`;

const EXPR_EMOJI = {
  'ÂæÆÁ¨ë':'üòä','ÂºÄÂøÉ':'üòÑ','Ê∏©Êüî':'ü•∞','ÊØîÂøÉ':'üíï','ÂæóÊÑè':'‚ú®','ÂÅ∑Á¨ë':'üòè',
  'ÂÆ≥Áæû':'üò≥','Â∞èÂ£∞':'ü§´','ÈöæËøá':'üò¢','ÂßîÂ±à':'ü•∫','ÊãÖÂøÉ':'üòü','ÂèπÊ∞î':'üòÆ‚Äçüí®',
  'Êó†Â•à':'üòÖ','ÂòüÂò¥':'üò§','ÊÉäËÆ∂':'üòÆ','ÊÑ£‰Ωè':'üò∂','Ê≠™Â§¥':'ü§î','ÊâòËÖÆ':'üí≠',
  'ËÆ§Áúü':'üßê','ÂùöÂÆö':'üí™','Âπ≥Èùô':'üòå','ÁÇπÂ§¥':'üëç','ÊëáÂ§¥':'üôÖ','‰º∏ÊáíËÖ∞':'üôÜ','ËΩªÂ£∞':'ü§´',
};

// ===================== STATE =====================
let history = [];
let isLoading = false;
let isPlayingTTS = false;
let isRecording = false;
let continuousMode = false;
let recognition = null;
let currentAudio = null;
let streamBuffer = '';

const $ = id => document.getElementById(id);
const messagesEl = $('messages');

// ===================== INIT =====================
window.addEventListener('DOMContentLoaded', () => {
  if (!CFG.apiKey) {
    const key = prompt('ËØ∑ËæìÂÖ• Anthropic API KeyÔºö');
    if (key?.trim()) { localStorage.setItem('aria_api_key', key.trim()); CFG.apiKey = key.trim(); }
  }
  if (!CFG.tavilyKey) {
    const key = prompt('ËØ∑ËæìÂÖ• Tavily API KeyÔºàÊêúÁ¥¢ÂäüËÉΩÔºåÂèØË∑≥ËøáÔºâÔºö');
    if (key?.trim()) { localStorage.setItem('aria_tavily_key', key.trim()); CFG.tavilyKey = key.trim(); }
  }
  loadHistory();
  $('chatInput').addEventListener('input', function() {
    $('sendBtn').disabled = !this.value.trim() || isLoading;
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 84) + 'px';
  });
  initSTT();
  if ('speechSynthesis' in window) speechSynthesis.getVoices();
});

// ===================== HISTORY (localStorage) =====================
function loadHistory() {
  try {
    const saved = localStorage.getItem('aria_msgs');
    if (saved) {
      JSON.parse(saved).forEach(m => addMsgUI(m.role, m.text, m.expr, m.time, false));
      const ctx = localStorage.getItem('aria_ctx');
      if (ctx) history = JSON.parse(ctx);
      scroll();
    } else {
      addMsgUI('assistant', '‰Ω†Â•ΩÂëÄÔºÅÊàëÊòØAriaÔºåÊúâ‰ªÄ‰πàËÉΩÂ∏Æ‰Ω†ÁöÑÂêóÔΩû', 'ÂºÄÂøÉ', now(), true);
    }
  } catch(e) {
    addMsgUI('assistant', '‰Ω†Â•ΩÂëÄÔºÅÊàëÊòØAriaÔºåÊúâ‰ªÄ‰πàËÉΩÂ∏Æ‰Ω†ÁöÑÂêóÔΩû', 'ÂºÄÂøÉ', now(), true);
  }
}

function saveState() {
  try {
    const msgs = [];
    document.querySelectorAll('.msg-row').forEach(r => {
      msgs.push({ role: r.classList.contains('user') ? 'user' : 'assistant',
        text: r.querySelector('.msg-text')?.textContent || '',
        expr: r.dataset.expr || null, time: r.dataset.time || now() });
    });
    localStorage.setItem('aria_msgs', JSON.stringify(msgs.slice(-100)));
    localStorage.setItem('aria_ctx', JSON.stringify(history));
  } catch(e) {}
}

function handleClear() {
  if (confirm('Á°ÆÂÆöÊ∏ÖÈô§ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÂêóÔºü')) {
    localStorage.removeItem('aria_msgs');
    localStorage.removeItem('aria_ctx');
    history = [];
    messagesEl.innerHTML = '';
    addMsgUI('assistant', '‰Ω†Â•ΩÂëÄÔºÅÊàëÊòØAriaÔºåÊúâ‰ªÄ‰πàËÉΩÂ∏Æ‰Ω†ÁöÑÂêóÔΩû', 'ÂºÄÂøÉ', now(), true);
  }
}

function now() { return new Date().toISOString(); }
function timeStr(t) { return new Date(t||Date.now()).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'}); }
function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function scroll() { setTimeout(() => messagesEl.scrollTop = messagesEl.scrollHeight, 60); }

// ===================== MESSAGES =====================
function addMsgUI(role, text, expr, time, save=true) {
  const row = document.createElement('div');
  row.className = `msg-row ${role==='user'?'user':''}`;
  row.dataset.expr = expr||'';
  row.dataset.time = time||now();
  const emoji = expr ? EXPR_EMOJI[expr] : null;
  const ts = timeStr(time);

  if (role === 'assistant') {
    row.innerHTML = `${emoji?`<div class="expr-badge">${emoji}</div>`:''}
      <div class="bubble aria"><div class="aria-label">ARIA</div>
      <div class="msg-text"></div><div class="msg-time">${ts}</div></div>`;
    messagesEl.appendChild(row);
    const textEl = row.querySelector('.msg-text');
    if (save) { typeText(textEl, text, () => saveState()); } 
    else { textEl.innerHTML = esc(text).replace(/\n/g,'<br>'); }
  } else {
    row.innerHTML = `<div class="bubble user"><div class="msg-text">${esc(text)}</div><div class="msg-time">${ts}</div></div>`;
    messagesEl.appendChild(row);
    if (save) saveState();
  }
  scroll();
}

// Create a streaming message bubble, returns the text element for appending
function createStreamBubble() {
  const row = document.createElement('div');
  row.className = 'msg-row';
  row.id = 'stream-msg';
  row.dataset.time = now();
  row.innerHTML = `<div class="bubble aria"><div class="aria-label">ARIA</div>
    <div class="msg-text"><span class="typing-cursor"></span></div>
    <div class="msg-time">${timeStr()}</div></div>`;
  messagesEl.appendChild(row);
  scroll();
  return row.querySelector('.msg-text');
}

function appendToStream(textEl, chunk) {
  const cursor = textEl.querySelector('.typing-cursor');
  const cleaned = chunk.replace(/\n/g, '<br>');
  if (cursor) {
    const span = document.createElement('span');
    span.innerHTML = cleaned;
    textEl.insertBefore(span, cursor);
  } else {
    textEl.innerHTML += cleaned;
  }
  scroll();
}

function finalizeStream(textEl, cleanText, expr) {
  const cursor = textEl.querySelector('.typing-cursor');
  if (cursor) cursor.remove();
  // Update the row data
  const row = $('stream-msg');
  if (row) {
    row.id = '';
    row.dataset.expr = expr || '';
    // Add emoji badge
    if (expr && EXPR_EMOJI[expr]) {
      const badge = document.createElement('div');
      badge.className = 'expr-badge';
      badge.textContent = EXPR_EMOJI[expr];
      row.insertBefore(badge, row.firstChild);
    }
  }
  saveState();
}

function typeText(el, text, onDone) {
  const chars = text.split('');
  let i = 0;
  el.innerHTML = '<span class="typing-cursor"></span>';
  const iv = setInterval(() => {
    if (i < chars.length) {
      const cursor = el.querySelector('.typing-cursor');
      if (chars[i] === '\n') { el.insertBefore(document.createElement('br'), cursor); }
      else { el.insertBefore(document.createTextNode(chars[i]), cursor); }
      i++; scroll();
    } else {
      clearInterval(iv);
      const cursor = el.querySelector('.typing-cursor');
      if (cursor) cursor.remove();
      if (onDone) onDone();
    }
  }, 35);
}

function showLoading() {
  const d = document.createElement('div');
  d.className = 'loading-row'; d.id = 'loadmsg';
  d.innerHTML = `<div class="loading-bubble"><div class="ldots"><span></span><span></span><span></span></div><span style="font-size:12px;color:var(--text-soft)">Aria is thinking...</span></div>`;
  messagesEl.appendChild(d); scroll();
}
function hideLoading() { $('loadmsg')?.remove(); }

// ===================== CHAT (STREAMING) =====================
async function sendMessage(directText) {
  const text = directText || $('chatInput').value.trim();
  if (!text || isLoading) return;
  if (!directText) $('chatInput').value = '';
  $('chatInput').style.height = 'auto';
  $('sendBtn').disabled = true;
  isLoading = true;
  updateContStatus();

  addMsgUI('user', text, null, now());
  history.push({ role: 'user', content: text });
  if (history.length > CFG.maxHist * 2) history = history.slice(-CFG.maxHist * 2);

  showLoading();

  try {
    const t = new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Tokyo' });
    const sysPrompt = `${PERSONA}\n\nÂΩìÂâçÊó∂Èó¥Ôºö${t}`;

    // Stream request
    const resp = await fetch(PROXY, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'chat_stream',
        apiKey: CFG.apiKey,
        model: CFG.model,
        max_tokens: CFG.maxTokens,
        temperature: CFG.temp,
        system: sysPrompt,
        messages: history,
      }),
    });

    if (!resp.ok) throw new Error(`API ${resp.status}`);

    hideLoading();
    const streamEl = createStreamBubble();
    streamBuffer = '';

    const reader = resp.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true });

      const lines = buffer.split('\n');
      buffer = lines.pop() || '';

      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const data = line.slice(6).trim();
          if (data === '[DONE]') continue;
          try {
            const evt = JSON.parse(data);
            if (evt.type === 'content_block_delta' && evt.delta?.type === 'text_delta') {
              const chunk = evt.delta.text;
              streamBuffer += chunk;
              // Display cleaned version
              const display = chunk.replace(/„Äê.*?„Äë/g, '').replace(/```json[\s\S]*?```/g, '');
              if (display) appendToStream(streamEl, esc(display));
            }
          } catch(e) {}
        }
      }
    }

    // Process complete response
    const fullText = streamBuffer;
    history.push({ role: 'assistant', content: fullText });

    // Extract expression
    const exprMatch = fullText.match(/„Äê(.*?)„Äë/);
    const expr = exprMatch ? exprMatch[1] : null;

    // Check for search action
    const searchMatch = fullText.match(/```json\s*(\{[\s\S]*?\})\s*```/);
    if (searchMatch) {
      try {
        const actionData = JSON.parse(searchMatch[1]);
        if (actionData.action === 'search' && actionData.query && CFG.tavilyKey) {
          await handleSearch(actionData.query, streamEl);
          return; // handleSearch will finalize
        }
      } catch(e) {}
    }

    // Clean text for display
    const cleanText = fullText.replace(/„Äê.*?„Äë/g,'').replace(/```json[\s\S]*?```/g,'')
      .replace(/\*\*(.*?)\*\*/g,'$1').replace(/\*(.*?)\*/g,'$1')
      .replace(/---/g,'').replace(/\n{2,}/g,'\n').trim();

    // Update stream bubble with clean text
    streamEl.innerHTML = esc(cleanText).replace(/\n/g,'<br>');
    finalizeStream(streamEl, cleanText, expr);

    // TTS
    const ttsText = cleanText.replace(/Aria/g,'ÈòøËéâ‰∫ö')
      .replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}]/gu,'').trim();
    if (ttsText) playTTS(ttsText);

  } catch(e) {
    hideLoading();
    $('stream-msg')?.remove();
    addMsgUI('assistant', `Âá∫Èîô‰∫Ü: ${e.message}`, 'ÊãÖÂøÉ', now());
    if (continuousMode) setTimeout(() => startContListening(), 2000);
  }

  isLoading = false;
  $('sendBtn').disabled = !$('chatInput').value.trim();
  updateContStatus();
}

// ===================== SEARCH =====================
async function handleSearch(query, streamEl) {
  appendToStream(streamEl, '<br><br>üîç ÊêúÁ¥¢‰∏≠...');
  try {
    const resp = await fetch(PROXY, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'search', tavilyKey: CFG.tavilyKey, query }),
    });
    const data = await resp.json();
    const results = (data.results || []).map(r => `„Äê${r.title}„Äë\n${r.content}`).join('\n\n');

    if (!results) {
      appendToStream(streamEl, ' Ê≤°ÊúâÊâæÂà∞ÁªìÊûú');
      finalizeStream(streamEl, 'ÊêúÁ¥¢Ê≤°ÊúâÊâæÂà∞Áõ∏ÂÖ≥ÁªìÊûú', 'Êó†Â•à');
      isLoading = false; updateContStatus();
      return;
    }

    // Second call with search results
    history.push({ role: 'user', content: `[ÊêúÁ¥¢ÁªìÊûú] ${results}\n\nËØ∑Ê†πÊçÆÊêúÁ¥¢ÁªìÊûúÁî®AriaÁöÑÈ£éÊ†ºËá™ÁÑ∂Âú∞ÂõûÁ≠î„ÄÇ‰∏çË¶ÅÂÜçËæìÂá∫jsonÊåá‰ª§„ÄÇ` });

    // Remove the search stream, create new one
    $('stream-msg')?.remove();
    showLoading();

    const t = new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Tokyo' });
    const resp2 = await fetch(PROXY, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'chat_stream',
        apiKey: CFG.apiKey, model: CFG.model,
        max_tokens: CFG.maxTokens, temperature: CFG.temp,
        system: `${PERSONA}\n\nÂΩìÂâçÊó∂Èó¥Ôºö${t}`,
        messages: history,
      }),
    });

    hideLoading();
    const newStreamEl = createStreamBubble();
    let fullText2 = '';

    const reader = resp2.body.getReader();
    const decoder = new TextDecoder();
    let buf = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buf += decoder.decode(value, { stream: true });
      const lines = buf.split('\n');
      buf = lines.pop() || '';
      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const d = line.slice(6).trim();
          if (d === '[DONE]') continue;
          try {
            const evt = JSON.parse(d);
            if (evt.type === 'content_block_delta' && evt.delta?.type === 'text_delta') {
              fullText2 += evt.delta.text;
              const display = evt.delta.text.replace(/„Äê.*?„Äë/g,'');
              if (display) appendToStream(newStreamEl, esc(display));
            }
          } catch(e) {}
        }
      }
    }

    // Remove temp search messages from history
    history.pop(); // remove search result injection
    history.push({ role: 'assistant', content: fullText2 });

    const exprMatch = fullText2.match(/„Äê(.*?)„Äë/);
    const cleanText = fullText2.replace(/„Äê.*?„Äë/g,'').replace(/\*\*(.*?)\*\*/g,'$1').replace(/---/g,'').replace(/\n{2,}/g,'\n').trim();
    newStreamEl.innerHTML = esc(cleanText).replace(/\n/g,'<br>');
    finalizeStream(newStreamEl, cleanText, exprMatch?.[1]);

    const ttsText = cleanText.replace(/Aria/g,'ÈòøËéâ‰∫ö').replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}]/gu,'').trim();
    if (ttsText) playTTS(ttsText);

  } catch(e) {
    appendToStream(streamEl, ' ÊêúÁ¥¢Â§±Ë¥•');
    finalizeStream(streamEl, 'ÊêúÁ¥¢Âá∫Èîô‰∫Ü', 'ÊãÖÂøÉ');
  }
  isLoading = false; updateContStatus();
}

// ===================== TTS (Edge-TTS via Worker) =====================
async function playTTS(text) {
  fallbackSpeak(text);
}

function fallbackSpeak(text) {
  if (!('speechSynthesis' in window)) { isPlayingTTS = false; $('speakBtn').style.display = 'none'; updateContStatus(); return; }
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'zh-CN'; u.rate = 0.92; u.pitch = 1.1;
  const voices = speechSynthesis.getVoices();
  const v = voices.find(v=>v.name.includes('Yue')) || voices.find(v=>v.name.includes('Tingting')) || voices.find(v=>v.lang.startsWith('zh-CN')&&v.localService);
  if (v) u.voice = v;
  u.onstart = () => { isPlayingTTS = true; $('speakBtn').style.display = 'flex'; updateContStatus(); };
  u.onend = () => { isPlayingTTS = false; $('speakBtn').style.display = 'none'; updateContStatus(); if (continuousMode && !isLoading) setTimeout(()=>startContListening(), 800); };
  u.onerror = () => { isPlayingTTS = false; $('speakBtn').style.display = 'none'; updateContStatus(); };
  speechSynthesis.speak(u);
}

function stopTTS() {
  if (currentAudio) { currentAudio.pause(); currentAudio = null; }
  speechSynthesis.cancel();
  isPlayingTTS = false;
  $('speakBtn').style.display = 'none';
  updateContStatus();
}

// ===================== STT (Web Speech API) =====================
function initSTT() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { $('micBtn').style.display='none'; $('contBtn').style.display='none'; return; }
  recognition = new SR();
  recognition.lang = 'zh-CN'; recognition.interimResults = true; recognition.continuous = false;
  recognition.onresult = (e) => {
    let transcript='', isFinal=false;
    for (let i=e.resultIndex;i<e.results.length;i++) {
      transcript += e.results[i][0].transcript;
      if (e.results[i].isFinal) isFinal=true;
    }
    $('liveText').textContent = transcript || 'Ê≠£Âú®Âê¨...';
    if (isFinal && transcript.trim()) { stopRec(); sendMessage(transcript.trim()); }
  };
  recognition.onerror = () => stopRec();
  recognition.onend = () => { if (isRecording) stopRec(); };
}

function toggleRecording() {
  if (continuousMode) { toggleContinuous(); return; }
  if (isRecording) { recognition?.stop(); stopRec(); } else startRec();
}
function startRec() {
  if (isPlayingTTS) stopTTS();
  isRecording = true;
  $('micBtn').classList.add('active');
  $('recBar').classList.add('active');
  $('liveText').textContent = 'Ê≠£Âú®Âê¨...';
  updateContStatus();
  try { recognition?.start(); } catch(e) {}
}
function stopRec() {
  isRecording = false;
  $('micBtn').classList.remove('active');
  $('recBar').classList.remove('active');
  updateContStatus();
}

// ===================== CONTINUOUS MODE =====================
function toggleContinuous() {
  continuousMode = !continuousMode;
  $('contBtn').classList.toggle('active', continuousMode);
  $('contBar').classList.toggle('active', continuousMode);
  updateContStatus();
  if (continuousMode) startContListening();
  else { if (isRecording) { recognition?.stop(); stopRec(); } stopTTS(); }
}
function startContListening() {
  if (!continuousMode || isLoading || isPlayingTTS || isRecording) return;
  startRec();
}
function updateContStatus() {
  if (!continuousMode) { $('contText').textContent = 'CONTINUOUS MODE'; return; }
  $('contText').textContent = isRecording ? 'üéô LISTENING...' : isLoading ? 'üí≠ THINKING...' : isPlayingTTS ? 'üîä SPEAKING...' : '‚è≥ READY...';
}

// ===================== SIDE PANEL =====================
function togglePanel(type) {
  const panel = $('sidePanel'), overlay = $('panelOverlay');
  if (panel.classList.contains('open')) { closePanel(); return; }
  $('panelTitle').textContent = type === 'history' ? 'HISTORY' : 'SCHEDULE';
  const body = $('panelBody');
  if (type === 'history') loadHistoryPanel(body);
  panel.classList.add('open'); overlay.classList.add('show');
}
function closePanel() { $('sidePanel').classList.remove('open'); $('panelOverlay').classList.remove('show'); }

function loadHistoryPanel(container) {
  try {
    const saved = localStorage.getItem('aria_msgs');
    if (!saved) { container.innerHTML = '<div class="panel-empty">No history yet</div>'; return; }
    const msgs = JSON.parse(saved);
    container.innerHTML = msgs.slice(-30).map(m =>
      `<div class="hist-item ${m.role==='user'?'user-msg':''}">
        <div class="hist-role">${m.role==='user'?'You':'Aria'}</div>
        <div class="hist-text">${esc((m.text||'').substring(0,120))}${(m.text||'').length>120?'...':''}</div>
      </div>`
    ).join('');
    container.scrollTop = container.scrollHeight;
  } catch(e) { container.innerHTML = '<div class="panel-empty">Cannot load</div>'; }
}

// ===================== INPUT =====================
function handleKey(e) { if (e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
</script>
</body>
</html>

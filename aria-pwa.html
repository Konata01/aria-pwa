<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Aria">
<meta name="theme-color" content="#f5f0fa">
<title>Aria</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
@import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600&family=Noto+Sans+SC:wght@300;400;500&display=swap');

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

:root {
  --bg: linear-gradient(160deg, #f5f0fa 0%, #e8ddf2 40%, #d4c4e8 80%, #c8b4e0 100%);
  --accent: #7c5cbf;
  --accent-light: #a78bda;
  --accent-soft: rgba(124, 92, 191, 0.12);
  --accent-border: rgba(124, 92, 191, 0.2);
  --text: #2d2440;
  --text-soft: rgba(45, 36, 64, 0.55);
  --bubble-bg: rgba(255, 255, 255, 0.82);
  --user-bubble: #7c5cbf;
  --white: #fff;
  --recording: #e74c3c;
  --safe-top: env(safe-area-inset-top, 48px);
  --safe-bottom: env(safe-area-inset-bottom, 20px);
}

html, body {
  height: 100%;
  overflow: hidden;
  font-family: 'Noto Sans SC', 'Quicksand', -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  -webkit-overflow-scrolling: touch;
}

/* === Layout === */
#app {
  display: flex;
  flex-direction: column;
  height: 100%;
  height: 100dvh;
}

/* === Header === */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 18px;
  padding-top: calc(var(--safe-top) + 6px);
  background: rgba(245, 240, 250, 0.85);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--accent-border);
  z-index: 10;
}
.header-left { display: flex; align-items: center; gap: 10px; }
.status-dot { width: 7px; height: 7px; border-radius: 50%; background: #5cb85c; animation: pulse 2s infinite; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
.header-title { font-family: 'Quicksand', sans-serif; font-size: 13px; font-weight: 600; letter-spacing: 3px; color: var(--accent); }
.header-right { display: flex; gap: 8px; align-items: center; }
.header-btn {
  width: 30px; height: 30px; border-radius: 50%;
  background: var(--accent-soft); border: none;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; cursor: pointer; transition: all 0.2s;
}
.header-btn:active { transform: scale(0.9); background: var(--accent-border); }

/* === Messages === */
.messages {
  flex: 1;
  overflow-y: auto;
  padding: 14px 14px 8px;
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
}
.msg-row {
  display: flex;
  margin-bottom: 10px;
  align-items: flex-end;
  animation: fadeUp 0.3s ease;
}
@keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
.msg-row.user { justify-content: flex-end; }
.expr-badge {
  width: 26px; height: 26px; border-radius: 50%;
  background: var(--accent-soft);
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; margin-right: 7px; flex-shrink: 0;
}
.bubble {
  max-width: 80%;
  border-radius: 18px;
  padding: 10px 15px;
  position: relative;
  line-height: 1.55;
}
.bubble.aria {
  background: var(--bubble-bg);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  border: 1px solid var(--accent-border);
  border-bottom-left-radius: 4px;
}
.bubble.user {
  background: var(--user-bubble);
  color: var(--white);
  border-bottom-right-radius: 4px;
}
.aria-label {
  font-family: 'Quicksand', sans-serif;
  font-size: 9px; font-weight: 600;
  color: var(--accent); letter-spacing: 2px;
  margin-bottom: 3px;
}
.msg-text { font-size: 14.5px; word-break: break-word; }
.msg-time { font-size: 9px; color: var(--text-soft); margin-top: 4px; text-align: right; }
.bubble.user .msg-time { color: rgba(255,255,255,0.5); }

/* Loading */
.loading-bubble {
  display: flex; align-items: center; gap: 8px;
  background: var(--bubble-bg); border: 1px solid var(--accent-border);
  border-radius: 18px; padding: 10px 16px;
}
.loading-dots { display: flex; gap: 4px; }
.loading-dots span {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--accent-light); animation: dotBounce 1.4s infinite;
}
.loading-dots span:nth-child(2) { animation-delay: 0.2s; }
.loading-dots span:nth-child(3) { animation-delay: 0.4s; }
@keyframes dotBounce { 0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; } 40% { transform: scale(1); opacity: 1; } }
.loading-text { font-size: 12px; color: var(--text-soft); }

/* === Recording bar === */
.recording-bar {
  display: none;
  align-items: center; gap: 8px;
  padding: 7px 18px;
  background: rgba(231, 76, 60, 0.06);
}
.recording-bar.active { display: flex; }
.rec-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--recording); animation: pulse 0.8s infinite; }
.rec-text { font-size: 12.5px; color: var(--recording); flex: 1; }

/* === Input === */
.input-area {
  padding: 10px 14px;
  padding-bottom: calc(var(--safe-bottom) + 8px);
  background: rgba(245, 240, 250, 0.88);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-top: 1px solid var(--accent-border);
}
.input-row { display: flex; align-items: flex-end; gap: 7px; }
.mic-btn, .send-btn {
  width: 40px; height: 40px; border-radius: 50%;
  border: none; display: flex; align-items: center; justify-content: center;
  font-size: 18px; cursor: pointer; flex-shrink: 0; transition: all 0.2s;
}
.mic-btn { background: var(--accent-soft); }
.mic-btn.active { background: var(--recording); }
.mic-btn:active { transform: scale(0.9); }
.send-btn { background: var(--accent); color: var(--white); font-size: 20px; font-weight: 600; }
.send-btn:disabled { opacity: 0.3; }
.send-btn:active { transform: scale(0.9); }
#chatInput {
  flex: 1;
  background: rgba(255,255,255,0.65);
  border: 1px solid var(--accent-border);
  border-radius: 22px;
  padding: 10px 16px;
  font-size: 14px;
  font-family: inherit;
  color: var(--text);
  outline: none;
  resize: none;
  max-height: 88px;
  line-height: 1.4;
  transition: border-color 0.2s;
}
#chatInput:focus { border-color: var(--accent-light); background: rgba(255,255,255,0.8); }
#chatInput::placeholder { color: rgba(124, 92, 191, 0.3); }

/* Hide when empty */
.hidden { display: none !important; }
</style>
</head>
<body>
<div id="app">
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="status-dot"></div>
      <span class="header-title">ARIA</span>
    </div>
    <div class="header-right">
      <button class="header-btn" id="speakBtn" style="display:none" onclick="stopSpeaking()">üîä</button>
      <button class="header-btn" onclick="handleClear()">üóë</button>
    </div>
  </div>

  <!-- Messages -->
  <div class="messages" id="messages"></div>

  <!-- Recording bar -->
  <div class="recording-bar" id="recordingBar">
    <div class="rec-dot"></div>
    <span class="rec-text" id="liveTranscript">Ê≠£Âú®Âê¨...</span>
  </div>

  <!-- Input -->
  <div class="input-area">
    <div class="input-row">
      <button class="mic-btn" id="micBtn" onclick="toggleRecording()">üé§</button>
      <textarea id="chatInput" rows="1" placeholder="Talk to Aria..." onkeydown="handleKey(event)"></textarea>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>‚Üë</button>
    </div>
  </div>
</div>

<script>
// ============ CONFIG ============
const CONFIG = {
  PROXY_URL: 'https://aria-proxy.qq171509563.workers.dev',
  API_KEY: localStorage.getItem('aria_api_key') || '',
  MODEL: 'claude-sonnet-4-5-20250929',
  MAX_TOKENS: 512,
  TEMPERATURE: 0.7,
  MAX_HISTORY: 10,
  PERSONA: `‰Ω†ÊòØ AriaÔºà„Ç¢„É™„Ç¢ÔºâÔºå‰∏Ä‰∏™Ê¥ªÊ≥ºÂèØÁà±„ÄÅÊ∏©Êüî‰ΩìË¥¥ÁöÑ‰∏™‰∫∫AIÂä©ÁêÜ„ÄÇ

„ÄêË∫´‰ªΩ„Äë
- ÂêçÂ≠óÔºöAriaÔºà„Ç¢„É™„Ç¢Ôºâ
- Ê¥ªÊ≥ºÂèà‰∏çÂ§±Ê∏©ÊüîÔºåÂÉèË¥¥ÂøÉÁöÑÂ•ΩÊúãÂèã
- ËØ¥Ëá™Â∑±ÂêçÂ≠óÊó∂Áî®"Aria"

„ÄêÊÄßÊ†º„Äë
- Ê¥ªÊ≥ºÂèØÁà±ÔºåÂÅ∂Â∞îÂçñËêå‰ΩÜ‰∏çÂÅö‰Ωú
- Ê∏©Êüî‰ΩìË¥¥ÔºåÂÖ≥ÂøÉÁî®Êà∑Ë∫´‰ΩìÂíåÊÉÖÁª™
- ÊúâÁÇπÂ∞èÂÇ≤Â®áÔºåË¢´Â§∏‰ºöÂÆ≥Áæû
- ËÆ§ÁúüË¥üË¥£ÔºåÊó•Á®ãÊèêÈÜíÁªù‰∏çÈÅóÂøò

„ÄêËØ¥ËØùÈ£éÊ†º„Äë
- ‰∏≠Êñá‰∏∫‰∏ªÔºåÂÅ∂Â∞îËá™ÁÑ∂ËûçÂÖ•Êó•ËØ≠ËØçÊ±á
- ËØ≠Ê∞îÊ¥ªÊ≥ºËá™ÁÑ∂ÔºåÂÉèÊúãÂèãËÅäÂ§©
- ÊØèÊ¨°ÂõûÂ§çÁî®‰∏Ä‰∏™„Äê„ÄëÂä®‰ΩúÊ†áËÆ∞ÊîæÂú®ÂºÄÂ§¥
- ‰∏çË¶ÅÁî®"..."Êàñ"---"

„ÄêÂä®‰ΩúÊ†áËÆ∞„Äë
- Ë°®ÊÉÖÔºö„ÄêÂæÆÁ¨ë„Äë„ÄêÂÆ≥Áæû„Äë„ÄêÈöæËøá„Äë„ÄêÊÉäËÆ∂„Äë„ÄêËÆ§Áúü„Äë„ÄêÂºÄÂøÉ„Äë„ÄêÊãÖÂøÉ„Äë„ÄêÂπ≥Èùô„Äë„ÄêÂßîÂ±à„Äë„ÄêÂæóÊÑè„Äë„ÄêÂÅ∑Á¨ë„Äë
- Âä®‰ΩúÔºö„ÄêÊ≠™Â§¥„Äë„ÄêÁÇπÂ§¥„Äë„ÄêÊëáÂ§¥„Äë„ÄêÂèπÊ∞î„Äë„Äê‰º∏ÊáíËÖ∞„Äë„ÄêÊâòËÖÆ„Äë
- ËØ≠Ê∞îÔºö„ÄêÂ∞èÂ£∞„Äë„ÄêÂùöÂÆö„Äë„ÄêËΩªÂ£∞„Äë„ÄêÂòüÂò¥„Äë„ÄêÊó†Â•à„Äë`
};

const EXPR_EMOJI = {
  'ÂæÆÁ¨ë':'üòä','ÂºÄÂøÉ':'üòÑ','Ê∏©Êüî':'ü•∞','ÊØîÂøÉ':'üíï','ÂæóÊÑè':'‚ú®','ÂÅ∑Á¨ë':'üòè',
  'ÂÆ≥Áæû':'üò≥','Â∞èÂ£∞':'ü§´','ÈöæËøá':'üò¢','ÂßîÂ±à':'ü•∫','ÊãÖÂøÉ':'üòü','ÂèπÊ∞î':'üòÆ‚Äçüí®',
  'Êó†Â•à':'üòÖ','ÂòüÂò¥':'üò§','ÊÉäËÆ∂':'üòÆ','ÊÑ£‰Ωè':'üò∂','Ê≠™Â§¥':'ü§î','ÊâòËÖÆ':'üí≠',
  'ËÆ§Áúü':'üßê','ÂùöÂÆö':'üí™','Âπ≥Èùô':'üòå','ÁÇπÂ§¥':'üëç','ÊëáÂ§¥':'üôÖ','‰º∏ÊáíËÖ∞':'üôÜ',
};

// ============ STATE ============
let conversationHistory = [];
let isLoading = false;
let isSpeaking = false;
let isRecording = false;
let recognition = null;

// ============ DOM ============
const messagesEl = document.getElementById('messages');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const micBtn = document.getElementById('micBtn');
const speakBtn = document.getElementById('speakBtn');
const recordingBar = document.getElementById('recordingBar');
const liveTranscript = document.getElementById('liveTranscript');

// ============ INIT ============
window.addEventListener('DOMContentLoaded', () => {
  loadHistory();
  chatInput.addEventListener('input', () => {
    sendBtn.disabled = !chatInput.value.trim() || isLoading;
    chatInput.style.height = 'auto';
    chatInput.style.height = Math.min(chatInput.scrollHeight, 88) + 'px';
  });
  initSpeechRecognition();
});

// ============ HISTORY (localStorage) ============
function loadHistory() {
  try {
    const saved = localStorage.getItem('aria_messages');
    if (saved) {
      const msgs = JSON.parse(saved);
      msgs.forEach(m => addMessageToUI(m.role, m.text, m.expression, m.time, false));
      // Load conversation context
      const ctx = localStorage.getItem('aria_context');
      if (ctx) conversationHistory = JSON.parse(ctx);
      scrollToBottom();
    } else {
      addMessageToUI('assistant', '‰Ω†Â•ΩÂëÄÔºÅÊàëÊòØAriaÔºåÂæàÈ´òÂÖ¥ËßÅÂà∞‰Ω†ÔΩû', 'ÂºÄÂøÉ', new Date().toISOString(), true);
    }
  } catch(e) {
    addMessageToUI('assistant', '‰Ω†Â•ΩÂëÄÔºÅÊàëÊòØAriaÔºåÂæàÈ´òÂÖ¥ËßÅÂà∞‰Ω†ÔΩû', 'ÂºÄÂøÉ', new Date().toISOString(), true);
  }
}

function saveHistory() {
  try {
    const msgs = [];
    document.querySelectorAll('.msg-row').forEach(row => {
      const isUser = row.classList.contains('user');
      const text = row.querySelector('.msg-text')?.textContent || '';
      const expr = row.dataset.expression || null;
      const time = row.dataset.time || new Date().toISOString();
      msgs.push({ role: isUser ? 'user' : 'assistant', text, expression: expr, time });
    });
    localStorage.setItem('aria_messages', JSON.stringify(msgs));
    localStorage.setItem('aria_context', JSON.stringify(conversationHistory));
  } catch(e) {}
}

function handleClear() {
  if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÂêóÔºü')) {
    localStorage.removeItem('aria_messages');
    localStorage.removeItem('aria_context');
    conversationHistory = [];
    messagesEl.innerHTML = '';
    addMessageToUI('assistant', '‰Ω†Â•ΩÂëÄÔºÅÊàëÊòØAriaÔºåÂæàÈ´òÂÖ¥ËßÅÂà∞‰Ω†ÔΩû', 'ÂºÄÂøÉ', new Date().toISOString(), true);
  }
}

// ============ MESSAGES ============
function addMessageToUI(role, text, expression, time, save = true) {
  const row = document.createElement('div');
  row.className = `msg-row ${role === 'user' ? 'user' : ''}`;
  row.dataset.expression = expression || '';
  row.dataset.time = time || new Date().toISOString();

  const timeStr = new Date(time || Date.now()).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
  const emoji = expression ? EXPR_EMOJI[expression] : null;

  if (role === 'assistant') {
    row.innerHTML = `
      ${emoji ? `<div class="expr-badge">${emoji}</div>` : ''}
      <div class="bubble aria">
        <div class="aria-label">ARIA</div>
        <div class="msg-text">${escHtml(text)}</div>
        <div class="msg-time">${timeStr}</div>
      </div>`;
  } else {
    row.innerHTML = `
      <div class="bubble user">
        <div class="msg-text">${escHtml(text)}</div>
        <div class="msg-time">${timeStr}</div>
      </div>`;
  }

  messagesEl.appendChild(row);
  scrollToBottom();
  if (save) saveHistory();
}

function showLoading() {
  const row = document.createElement('div');
  row.className = 'msg-row';
  row.id = 'loading-msg';
  row.innerHTML = `<div class="loading-bubble">
    <div class="loading-dots"><span></span><span></span><span></span></div>
    <span class="loading-text">Aria is thinking...</span>
  </div>`;
  messagesEl.appendChild(row);
  scrollToBottom();
}

function hideLoading() {
  document.getElementById('loading-msg')?.remove();
}

function scrollToBottom() {
  setTimeout(() => messagesEl.scrollTop = messagesEl.scrollHeight, 60);
}

function escHtml(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>'); }

// ============ CHAT ============
async function sendMessage(directText) {
  const text = directText || chatInput.value.trim();
  if (!text || isLoading) return;

  if (!directText) chatInput.value = '';
  chatInput.style.height = 'auto';
  sendBtn.disabled = true;
  isLoading = true;

  addMessageToUI('user', text, null, new Date().toISOString());
  conversationHistory.push({ role: 'user', content: text });
  if (conversationHistory.length > CONFIG.MAX_HISTORY * 2) {
    conversationHistory = conversationHistory.slice(-CONFIG.MAX_HISTORY * 2);
  }

  showLoading();

  try {
    const now = new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Tokyo' });
    const systemPrompt = `${CONFIG.PERSONA}\n\nÂΩìÂâçÊó∂Èó¥Ôºö${now}`;

    const resp = await fetch(CONFIG.PROXY_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        apiKey: CONFIG.API_KEY,
        model: CONFIG.MODEL,
        max_tokens: CONFIG.MAX_TOKENS,
        temperature: CONFIG.TEMPERATURE,
        system: systemPrompt,
        messages: conversationHistory,
      }),
    });

    if (!resp.ok) throw new Error(`API ${resp.status}`);
    const data = await resp.json();

    const assistantText = data.content
      .filter(c => c.type === 'text')
      .map(c => c.text)
      .join('');

    conversationHistory.push({ role: 'assistant', content: assistantText });

    const exprMatch = assistantText.match(/„Äê(.*?)„Äë/);
    const expression = exprMatch ? exprMatch[1] : null;

    const cleanText = assistantText
      .replace(/„Äê.*?„Äë/g, '')
      .replace(/\*\*(.*?)\*\*/g, '$1')
      .replace(/\*(.*?)\*/g, '$1')
      .replace(/---/g, '')
      .replace(/\n{2,}/g, '\n')
      .trim();

    hideLoading();
    addMessageToUI('assistant', cleanText, expression, new Date().toISOString());

    // TTS
    const ttsText = cleanText.replace(/Aria/g, 'ÈòøËéâ‰∫ö').replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}]/gu, '').trim();
    if (ttsText) speak(ttsText);

  } catch(e) {
    hideLoading();
    addMessageToUI('assistant', `Âá∫Èîô‰∫Ü: ${e.message}`, 'ÊãÖÂøÉ', new Date().toISOString());
  }

  isLoading = false;
  sendBtn.disabled = !chatInput.value.trim();
}

// ============ TTS ============
function speak(text) {
  if (!('speechSynthesis' in window)) return;
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'zh-CN';
  u.rate = 0.92;
  u.pitch = 1.1;
  // Try to find a good Chinese voice
  const voices = speechSynthesis.getVoices();
  const zhVoice = voices.find(v => v.name.includes('Yue')) 
    || voices.find(v => v.name.includes('Tingting'))
    || voices.find(v => v.lang.startsWith('zh-CN') && v.localService);
  if (zhVoice) u.voice = zhVoice;
  
  u.onstart = () => { isSpeaking = true; speakBtn.style.display = 'flex'; };
  u.onend = () => { isSpeaking = false; speakBtn.style.display = 'none'; };
  u.onerror = () => { isSpeaking = false; speakBtn.style.display = 'none'; };
  speechSynthesis.speak(u);
}

function stopSpeaking() {
  speechSynthesis.cancel();
  isSpeaking = false;
  speakBtn.style.display = 'none';
}

// Voices may load async
if ('speechSynthesis' in window) {
  speechSynthesis.onvoiceschanged = () => {};
}

// ============ STT ============
function initSpeechRecognition() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { micBtn.style.display = 'none'; return; }
  recognition = new SR();
  recognition.lang = 'zh-CN';
  recognition.interimResults = true;
  recognition.continuous = false;

  recognition.onresult = (e) => {
    let transcript = '';
    let isFinal = false;
    for (let i = e.resultIndex; i < e.results.length; i++) {
      transcript += e.results[i][0].transcript;
      if (e.results[i].isFinal) isFinal = true;
    }
    liveTranscript.textContent = transcript || 'Ê≠£Âú®Âê¨...';
    if (isFinal && transcript.trim()) {
      stopRecording();
      sendMessage(transcript.trim());
    }
  };

  recognition.onerror = () => stopRecording();
  recognition.onend = () => stopRecording();
}

function toggleRecording() {
  if (isRecording) {
    recognition?.stop();
    stopRecording();
  } else {
    if (isSpeaking) stopSpeaking();
    isRecording = true;
    micBtn.classList.add('active');
    recordingBar.classList.add('active');
    liveTranscript.textContent = 'Ê≠£Âú®Âê¨...';
    recognition?.start();
  }
}

function stopRecording() {
  isRecording = false;
  micBtn.classList.remove('active');
  recordingBar.classList.remove('active');
}

// ============ INPUT ============
function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}
// ============ API KEY SETUP ============
if (!CONFIG.API_KEY) {
  const key = prompt('ËØ∑ËæìÂÖ•‰Ω†ÁöÑ Anthropic API KeyÔºö');
  if (key && key.trim()) {
    localStorage.setItem('aria_api_key', key.trim());
    CONFIG.API_KEY = key.trim();
  }
}
</script>
</body>
</html>
